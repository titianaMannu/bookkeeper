<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ZooKeeperClient.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Tests</a> &gt; <a href="../index.html" class="el_bundle">bookkeeper-server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.zookeeper</a> &gt; <span class="el_source">ZooKeeperClient.java</span></div><h1>ZooKeeperClient.java</h1><pre class="source lang-java linenums">/**
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 *
 */
package org.apache.bookkeeper.zookeeper;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkNotNull;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.util.concurrent.RateLimiter;
import com.google.common.util.concurrent.ThreadFactoryBuilder;
import java.io.IOException;
import java.util.List;
import java.util.Set;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.RejectedExecutionException;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicReference;
import org.apache.bookkeeper.stats.NullStatsLogger;
import org.apache.bookkeeper.stats.OpStatsLogger;
import org.apache.bookkeeper.stats.StatsLogger;
import org.apache.bookkeeper.zookeeper.ZooWorker.ZooCallable;
import org.apache.zookeeper.AsyncCallback.ACLCallback;
import org.apache.zookeeper.AsyncCallback.Children2Callback;
import org.apache.zookeeper.AsyncCallback.ChildrenCallback;
import org.apache.zookeeper.AsyncCallback.DataCallback;
import org.apache.zookeeper.AsyncCallback.MultiCallback;
import org.apache.zookeeper.AsyncCallback.StatCallback;
import org.apache.zookeeper.AsyncCallback.StringCallback;
import org.apache.zookeeper.AsyncCallback.VoidCallback;
import org.apache.zookeeper.CreateMode;
import org.apache.zookeeper.KeeperException;
import org.apache.zookeeper.Op;
import org.apache.zookeeper.OpResult;
import org.apache.zookeeper.Transaction;
import org.apache.zookeeper.WatchedEvent;
import org.apache.zookeeper.Watcher;
import org.apache.zookeeper.Watcher.Event.EventType;
import org.apache.zookeeper.Watcher.Event.KeeperState;
import org.apache.zookeeper.ZooKeeper;
import org.apache.zookeeper.data.ACL;
import org.apache.zookeeper.data.Stat;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Provide a zookeeper client to handle session expire.
 */
public class ZooKeeperClient extends ZooKeeper implements Watcher, AutoCloseable {

<span class="nc" id="L72">    private static final Logger logger = LoggerFactory.getLogger(ZooKeeperClient.class);</span>

    private static final int DEFAULT_RETRY_EXECUTOR_THREAD_COUNT = 1;

    // ZooKeeper client connection variables
    private final String connectString;
    private final int sessionTimeoutMs;
    private final boolean allowReadOnlyMode;

    // state for the zookeeper client
<span class="nc" id="L82">    private final AtomicReference&lt;ZooKeeper&gt; zk = new AtomicReference&lt;ZooKeeper&gt;();</span>
<span class="nc" id="L83">    private final AtomicBoolean closed = new AtomicBoolean(false);</span>
    private final ZooKeeperWatcherBase watcherManager;

    private final ScheduledExecutorService retryExecutor;
    private final ExecutorService connectExecutor;

    // rate limiter
    private final RateLimiter rateLimiter;

    // retry polices
    private final RetryPolicy connectRetryPolicy;
    private final RetryPolicy operationRetryPolicy;

    // Stats Logger
    private final OpStatsLogger createStats;
    private final OpStatsLogger getStats;
    private final OpStatsLogger setStats;
    private final OpStatsLogger deleteStats;
    private final OpStatsLogger getChildrenStats;
    private final OpStatsLogger existsStats;
    private final OpStatsLogger multiStats;
    private final OpStatsLogger getACLStats;
    private final OpStatsLogger setACLStats;
    private final OpStatsLogger syncStats;
    private final OpStatsLogger createClientStats;

<span class="nc" id="L109">    private final Callable&lt;ZooKeeper&gt; clientCreator = new Callable&lt;ZooKeeper&gt;() {</span>

        @Override
        public ZooKeeper call() throws Exception {
            try {
<span class="nc" id="L114">                return ZooWorker.syncCallWithRetries(null, new ZooCallable&lt;ZooKeeper&gt;() {</span>

                    @Override
                    public ZooKeeper call() throws KeeperException, InterruptedException {
<span class="nc" id="L118">                        logger.info(&quot;Reconnecting zookeeper {}.&quot;, connectString);</span>
                        // close the previous one
<span class="nc" id="L120">                        closeZkHandle();</span>
                        ZooKeeper newZk;
                        try {
<span class="nc" id="L123">                            newZk = createZooKeeper();</span>
<span class="nc" id="L124">                        } catch (IOException ie) {</span>
<span class="nc" id="L125">                            logger.error(&quot;Failed to create zookeeper instance to &quot; + connectString, ie);</span>
<span class="nc" id="L126">                            throw KeeperException.create(KeeperException.Code.CONNECTIONLOSS);</span>
<span class="nc" id="L127">                        }</span>
<span class="nc" id="L128">                        waitForConnection();</span>
<span class="nc" id="L129">                        zk.set(newZk);</span>
<span class="nc" id="L130">                        logger.info(&quot;ZooKeeper session {} is created to {}.&quot;,</span>
<span class="nc" id="L131">                                Long.toHexString(newZk.getSessionId()), connectString);</span>
<span class="nc" id="L132">                        return newZk;</span>
                    }

                    @Override
                    public String toString() {
<span class="nc" id="L137">                        return String.format(&quot;ZooKeeper Client Creator (%s)&quot;, connectString);</span>
                    }

<span class="nc" id="L140">                }, connectRetryPolicy, rateLimiter, createClientStats);</span>
<span class="nc" id="L141">            } catch (Exception e) {</span>
<span class="nc" id="L142">                logger.error(&quot;Gave up reconnecting to ZooKeeper : &quot;, e);</span>
<span class="nc" id="L143">                Runtime.getRuntime().exit(-1);</span>
<span class="nc" id="L144">                return null;</span>
            }
        }

    };

    @VisibleForTesting
    static ZooKeeperClient createConnectedZooKeeperClient(
            String connectString, int sessionTimeoutMs, Set&lt;Watcher&gt; childWatchers,
            RetryPolicy operationRetryPolicy)
                    throws KeeperException, InterruptedException, IOException {
<span class="nc" id="L155">        return ZooKeeperClient.newBuilder()</span>
<span class="nc" id="L156">                .connectString(connectString)</span>
<span class="nc" id="L157">                .sessionTimeoutMs(sessionTimeoutMs)</span>
<span class="nc" id="L158">                .watchers(childWatchers)</span>
<span class="nc" id="L159">                .operationRetryPolicy(operationRetryPolicy)</span>
<span class="nc" id="L160">                .build();</span>
    }

    /**
     * A builder to build retryable zookeeper client.
     */
    public static class Builder {
<span class="nc" id="L167">        String connectString = null;</span>
<span class="nc" id="L168">        int sessionTimeoutMs = 10000;</span>
<span class="nc" id="L169">        Set&lt;Watcher&gt; watchers = null;</span>
<span class="nc" id="L170">        RetryPolicy connectRetryPolicy = null;</span>
<span class="nc" id="L171">        RetryPolicy operationRetryPolicy = null;</span>
<span class="nc" id="L172">        StatsLogger statsLogger = NullStatsLogger.INSTANCE;</span>
<span class="nc" id="L173">        int retryExecThreadCount = DEFAULT_RETRY_EXECUTOR_THREAD_COUNT;</span>
<span class="nc" id="L174">        double requestRateLimit = 0;</span>
<span class="nc" id="L175">        boolean allowReadOnlyMode = false;</span>

<span class="nc" id="L177">        private Builder() {}</span>

        public Builder connectString(String connectString) {
<span class="nc" id="L180">            this.connectString = connectString;</span>
<span class="nc" id="L181">            return this;</span>
        }

        public Builder sessionTimeoutMs(int sessionTimeoutMs) {
<span class="nc" id="L185">            this.sessionTimeoutMs = sessionTimeoutMs;</span>
<span class="nc" id="L186">            return this;</span>
        }

        public Builder watchers(Set&lt;Watcher&gt; watchers) {
<span class="nc" id="L190">            this.watchers = watchers;</span>
<span class="nc" id="L191">            return this;</span>
        }

        public Builder connectRetryPolicy(RetryPolicy retryPolicy) {
<span class="nc" id="L195">            this.connectRetryPolicy = retryPolicy;</span>
<span class="nc" id="L196">            return this;</span>
        }

        public Builder operationRetryPolicy(RetryPolicy retryPolicy) {
<span class="nc" id="L200">            this.operationRetryPolicy = retryPolicy;</span>
<span class="nc" id="L201">            return this;</span>
        }

        public Builder statsLogger(StatsLogger statsLogger) {
<span class="nc" id="L205">            this.statsLogger = statsLogger;</span>
<span class="nc" id="L206">            return this;</span>
        }

        public Builder requestRateLimit(double requestRateLimit) {
<span class="nc" id="L210">            this.requestRateLimit = requestRateLimit;</span>
<span class="nc" id="L211">            return this;</span>
        }

        public Builder retryThreadCount(int numThreads) {
<span class="nc" id="L215">            this.retryExecThreadCount = numThreads;</span>
<span class="nc" id="L216">            return this;</span>
        }

        public Builder allowReadOnlyMode(boolean allowReadOnlyMode) {
<span class="nc" id="L220">            this.allowReadOnlyMode = allowReadOnlyMode;</span>
<span class="nc" id="L221">            return this;</span>
        }

        public ZooKeeperClient build() throws IOException, KeeperException, InterruptedException {
<span class="nc" id="L225">            checkNotNull(connectString);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            checkArgument(sessionTimeoutMs &gt; 0);</span>
<span class="nc" id="L227">            checkNotNull(statsLogger);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            checkArgument(retryExecThreadCount &gt; 0);</span>

<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (null == connectRetryPolicy) {</span>
                // Session expiry event is received by client only when zk quorum is well established.
                // All other connection loss retries happen at zk client library transparently.
                // Hence, we don't need to wait before retrying.
<span class="nc" id="L234">                connectRetryPolicy =</span>
                        new BoundExponentialBackoffRetryPolicy(0, 0, Integer.MAX_VALUE);
            }
<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (null == operationRetryPolicy) {</span>
<span class="nc" id="L238">                operationRetryPolicy =</span>
                        new BoundExponentialBackoffRetryPolicy(sessionTimeoutMs, sessionTimeoutMs, 0);
            }

            // Create a watcher manager
<span class="nc" id="L243">            StatsLogger watcherStatsLogger = statsLogger.scope(&quot;watcher&quot;);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">            ZooKeeperWatcherBase watcherManager =</span>
                    null == watchers ? new ZooKeeperWatcherBase(sessionTimeoutMs, watcherStatsLogger) :
                            new ZooKeeperWatcherBase(sessionTimeoutMs, watchers, watcherStatsLogger);
<span class="nc" id="L247">            ZooKeeperClient client = new ZooKeeperClient(</span>
                    connectString,
                    sessionTimeoutMs,
                    watcherManager,
                    connectRetryPolicy,
                    operationRetryPolicy,
                    statsLogger,
                    retryExecThreadCount,
                    requestRateLimit,
                    allowReadOnlyMode
            );
            // Wait for connection to be established.
            try {
<span class="nc" id="L260">                watcherManager.waitForConnection();</span>
<span class="nc" id="L261">            } catch (KeeperException ke) {</span>
<span class="nc" id="L262">                client.close();</span>
<span class="nc" id="L263">                throw ke;</span>
<span class="nc" id="L264">            } catch (InterruptedException ie) {</span>
<span class="nc" id="L265">                Thread.currentThread().interrupt();</span>
<span class="nc" id="L266">                client.close();</span>
<span class="nc" id="L267">                throw ie;</span>
<span class="nc" id="L268">            }</span>
<span class="nc" id="L269">            return client;</span>
        }
    }

    public static Builder newBuilder() {
<span class="nc" id="L274">        return new Builder();</span>
    }

    protected ZooKeeperClient(String connectString,
                    int sessionTimeoutMs,
                    ZooKeeperWatcherBase watcherManager,
                    RetryPolicy connectRetryPolicy,
                    RetryPolicy operationRetryPolicy,
                    StatsLogger statsLogger,
                    int retryExecThreadCount,
                    double rate,
                    boolean allowReadOnlyMode) throws IOException {
<span class="nc" id="L286">        super(connectString, sessionTimeoutMs, watcherManager, allowReadOnlyMode);</span>
<span class="nc" id="L287">        this.connectString = connectString;</span>
<span class="nc" id="L288">        this.sessionTimeoutMs = sessionTimeoutMs;</span>
<span class="nc" id="L289">        this.allowReadOnlyMode =  allowReadOnlyMode;</span>
<span class="nc" id="L290">        this.watcherManager = watcherManager;</span>
<span class="nc" id="L291">        this.connectRetryPolicy = connectRetryPolicy;</span>
<span class="nc" id="L292">        this.operationRetryPolicy = operationRetryPolicy;</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        this.rateLimiter = rate &gt; 0 ? RateLimiter.create(rate) : null;</span>
<span class="nc" id="L294">        this.retryExecutor =</span>
<span class="nc" id="L295">                Executors.newScheduledThreadPool(retryExecThreadCount,</span>
<span class="nc" id="L296">                    new ThreadFactoryBuilder().setNameFormat(&quot;ZKC-retry-executor-%d&quot;).build());</span>
<span class="nc" id="L297">        this.connectExecutor =</span>
<span class="nc" id="L298">                Executors.newSingleThreadExecutor(</span>
<span class="nc" id="L299">                    new ThreadFactoryBuilder().setNameFormat(&quot;ZKC-connect-executor-%d&quot;).build());</span>
        // added itself to the watcher
<span class="nc" id="L301">        watcherManager.addChildWatcher(this);</span>

        // Stats
<span class="nc" id="L304">        StatsLogger scopedStatsLogger = statsLogger.scope(&quot;zk&quot;);</span>
<span class="nc" id="L305">        createClientStats = scopedStatsLogger.getOpStatsLogger(&quot;create_client&quot;);</span>
<span class="nc" id="L306">        createStats = scopedStatsLogger.getOpStatsLogger(&quot;create&quot;);</span>
<span class="nc" id="L307">        getStats = scopedStatsLogger.getOpStatsLogger(&quot;get_data&quot;);</span>
<span class="nc" id="L308">        setStats = scopedStatsLogger.getOpStatsLogger(&quot;set_data&quot;);</span>
<span class="nc" id="L309">        deleteStats = scopedStatsLogger.getOpStatsLogger(&quot;delete&quot;);</span>
<span class="nc" id="L310">        getChildrenStats = scopedStatsLogger.getOpStatsLogger(&quot;get_children&quot;);</span>
<span class="nc" id="L311">        existsStats = scopedStatsLogger.getOpStatsLogger(&quot;exists&quot;);</span>
<span class="nc" id="L312">        multiStats = scopedStatsLogger.getOpStatsLogger(&quot;multi&quot;);</span>
<span class="nc" id="L313">        getACLStats = scopedStatsLogger.getOpStatsLogger(&quot;get_acl&quot;);</span>
<span class="nc" id="L314">        setACLStats = scopedStatsLogger.getOpStatsLogger(&quot;set_acl&quot;);</span>
<span class="nc" id="L315">        syncStats = scopedStatsLogger.getOpStatsLogger(&quot;sync&quot;);</span>
<span class="nc" id="L316">    }</span>

    @Override
    public void close() throws InterruptedException {
<span class="nc" id="L320">        closed.set(true);</span>
<span class="nc" id="L321">        connectExecutor.shutdown();</span>
<span class="nc" id="L322">        retryExecutor.shutdown();</span>
<span class="nc" id="L323">        closeZkHandle();</span>
<span class="nc" id="L324">    }</span>

    private void closeZkHandle() throws InterruptedException {
<span class="nc" id="L327">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L329">            super.close();</span>
        } else {
<span class="nc" id="L331">            zkHandle.close();</span>
        }
<span class="nc" id="L333">    }</span>

    public void waitForConnection() throws KeeperException, InterruptedException {
<span class="nc" id="L336">        watcherManager.waitForConnection();</span>
<span class="nc" id="L337">    }</span>

    protected ZooKeeper createZooKeeper() throws IOException {
<span class="nc" id="L340">        return new ZooKeeper(connectString, sessionTimeoutMs, watcherManager, allowReadOnlyMode);</span>
    }

    @Override
    public void process(WatchedEvent event) {
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (event.getType() == EventType.None</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">            &amp;&amp; event.getState() == KeeperState.Expired) {</span>
<span class="nc" id="L347">            onExpired();</span>
        }
<span class="nc" id="L349">    }</span>

    private void onExpired() {
<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (closed.get()) {</span>
            // we don't schedule any tries if the client is closed.
<span class="nc" id="L354">            return;</span>
        }

<span class="nc" id="L357">        logger.info(&quot;ZooKeeper session {} is expired from {}.&quot;,</span>
<span class="nc" id="L358">                Long.toHexString(getSessionId()), connectString);</span>
        try {
<span class="nc" id="L360">            connectExecutor.submit(clientCreator);</span>
<span class="nc" id="L361">        } catch (RejectedExecutionException ree) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">            if (!closed.get()) {</span>
<span class="nc" id="L363">                logger.error(&quot;ZooKeeper reconnect task is rejected : &quot;, ree);</span>
            }
<span class="nc" id="L365">        } catch (Exception t) {</span>
<span class="nc" id="L366">            logger.error(&quot;Failed to submit zookeeper reconnect task due to runtime exception : &quot;, t);</span>
<span class="nc" id="L367">        }</span>
<span class="nc" id="L368">    }</span>

    /**
     * A runnable that retries zookeeper operations.
     */
    abstract static class ZkRetryRunnable implements Runnable {

        final ZooWorker worker;
        final RateLimiter rateLimiter;
        final Runnable that;

        ZkRetryRunnable(RetryPolicy retryPolicy,
                        RateLimiter rateLimiter,
<span class="nc" id="L381">                        OpStatsLogger statsLogger) {</span>
<span class="nc" id="L382">            this.worker = new ZooWorker(retryPolicy, statsLogger);</span>
<span class="nc" id="L383">            this.rateLimiter = rateLimiter;</span>
<span class="nc" id="L384">            that = this;</span>
<span class="nc" id="L385">        }</span>

        @Override
        public void run() {
<span class="nc bnc" id="L389" title="All 2 branches missed.">            if (null != rateLimiter) {</span>
<span class="nc" id="L390">                rateLimiter.acquire();</span>
            }
<span class="nc" id="L392">            zkRun();</span>
<span class="nc" id="L393">        }</span>

        abstract void zkRun();
    }

    // inherits from ZooKeeper client for all operations

    @Override
    public long getSessionId() {
<span class="nc" id="L402">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L404">            return super.getSessionId();</span>
        }
<span class="nc" id="L406">        return zkHandle.getSessionId();</span>
    }

    @Override
    public byte[] getSessionPasswd() {
<span class="nc" id="L411">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L413">            return super.getSessionPasswd();</span>
        }
<span class="nc" id="L415">        return zkHandle.getSessionPasswd();</span>
    }

    @Override
    public int getSessionTimeout() {
<span class="nc" id="L420">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L422">            return super.getSessionTimeout();</span>
        }
<span class="nc" id="L424">        return zkHandle.getSessionTimeout();</span>
    }

    @Override
    public void addAuthInfo(String scheme, byte[] auth) {
<span class="nc" id="L429">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L431">            super.addAuthInfo(scheme, auth);</span>
<span class="nc" id="L432">            return;</span>
        }
<span class="nc" id="L434">        zkHandle.addAuthInfo(scheme, auth);</span>
<span class="nc" id="L435">    }</span>

    private void backOffAndRetry(Runnable r, long nextRetryWaitTimeMs) {
        try {
<span class="nc" id="L439">            retryExecutor.schedule(r, nextRetryWaitTimeMs, TimeUnit.MILLISECONDS);</span>
<span class="nc" id="L440">        } catch (RejectedExecutionException ree) {</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            if (!closed.get()) {</span>
<span class="nc" id="L442">                logger.error(&quot;ZooKeeper Operation {} is rejected : &quot;, r, ree);</span>
            }
<span class="nc" id="L444">        }</span>
<span class="nc" id="L445">    }</span>

    private boolean allowRetry(ZooWorker worker, int rc) {
<span class="nc bnc" id="L448" title="All 4 branches missed.">        return worker.allowRetry(rc) &amp;&amp; !closed.get();</span>
    }

    @Override
    public synchronized void register(Watcher watcher) {
<span class="nc" id="L453">        watcherManager.addChildWatcher(watcher);</span>
<span class="nc" id="L454">    }</span>

    @Override
    public List&lt;OpResult&gt; multi(final Iterable&lt;Op&gt; ops) throws InterruptedException, KeeperException {
<span class="nc" id="L458">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;OpResult&gt;&gt;() {</span>

            @Override
            public String toString() {
<span class="nc" id="L462">                return &quot;multi&quot;;</span>
            }

            @Override
            public List&lt;OpResult&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L467">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L469">                    return ZooKeeperClient.super.multi(ops);</span>
                }
<span class="nc" id="L471">                return zkHandle.multi(ops);</span>
            }

        }, operationRetryPolicy, rateLimiter, multiStats);
    }

    @Override
    public void multi(final Iterable&lt;Op&gt; ops,
                      final MultiCallback cb,
                      final Object context) {
<span class="nc" id="L481">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, createStats) {</span>

<span class="nc" id="L483">            final MultiCallback multiCb = new MultiCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, List&lt;OpResult&gt; results) {
<span class="nc" id="L487">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L489">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L491">                        cb.processResult(rc, path, context, results);</span>
                    }
<span class="nc" id="L493">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L499">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L501">                    ZooKeeperClient.super.multi(ops, multiCb, worker);</span>
                } else {
<span class="nc" id="L503">                    zkHandle.multi(ops, multiCb, worker);</span>
                }
<span class="nc" id="L505">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L509">                return &quot;multi&quot;;</span>
            }
        };
        // execute it immediately
<span class="nc" id="L513">        proc.run();</span>
<span class="nc" id="L514">    }</span>

    @Override
    @Deprecated
    public Transaction transaction() {
        // since there is no reference about which client that the transaction could use
        // so just use ZooKeeper instance directly.
        // you'd better to use {@link #multi}.
<span class="nc" id="L522">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L524">            return super.transaction();</span>
        }
<span class="nc" id="L526">        return zkHandle.transaction();</span>
    }

    @Override
    public List&lt;ACL&gt; getACL(final String path, final Stat stat) throws KeeperException, InterruptedException {
<span class="nc" id="L531">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;ACL&gt;&gt;() {</span>

            @Override
            public String toString() {
<span class="nc" id="L535">                return String.format(&quot;getACL (%s, stat = %s)&quot;, path, stat);</span>
            }

            @Override
            public List&lt;ACL&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L540">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L542">                    return ZooKeeperClient.super.getACL(path, stat);</span>
                }
<span class="nc" id="L544">                return zkHandle.getACL(path, stat);</span>
            }

        }, operationRetryPolicy, rateLimiter, getACLStats);
    }

    @Override
    public void getACL(final String path, final Stat stat, final ACLCallback cb, final Object context) {
<span class="nc" id="L552">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getACLStats) {</span>

<span class="nc" id="L554">            final ACLCallback aclCb = new ACLCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, List&lt;ACL&gt; acl, Stat stat) {
<span class="nc" id="L558">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L560">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L562">                        cb.processResult(rc, path, context, acl, stat);</span>
                    }
<span class="nc" id="L564">                }</span>

            };

            @Override
            public String toString() {
<span class="nc" id="L570">                return String.format(&quot;getACL (%s, stat = %s)&quot;, path, stat);</span>
            }

            @Override
            void zkRun() {
<span class="nc" id="L575">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L577">                    ZooKeeperClient.super.getACL(path, stat, aclCb, worker);</span>
                } else {
<span class="nc" id="L579">                    zkHandle.getACL(path, stat, aclCb, worker);</span>
                }
<span class="nc" id="L581">            }</span>
        };
        // execute it immediately
<span class="nc" id="L584">        proc.run();</span>
<span class="nc" id="L585">    }</span>

    @Override
    public Stat setACL(final String path, final List&lt;ACL&gt; acl, final int version)
            throws KeeperException, InterruptedException {
<span class="nc" id="L590">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public String toString() {
<span class="nc" id="L594">                return String.format(&quot;setACL (%s, acl = %s, version = %d)&quot;, path, acl, version);</span>
            }

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L599">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L601">                    return ZooKeeperClient.super.setACL(path, acl, version);</span>
                }
<span class="nc" id="L603">                return zkHandle.setACL(path, acl, version);</span>
            }

        }, operationRetryPolicy, rateLimiter, setACLStats);
    }

    @Override
    public void setACL(final String path, final List&lt;ACL&gt; acl, final int version,
            final StatCallback cb, final Object context) {
<span class="nc" id="L612">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, setACLStats) {</span>

<span class="nc" id="L614">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L618">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L620">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L622">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L624">                }</span>

            };

            @Override
            public String toString() {
<span class="nc" id="L630">                return String.format(&quot;setACL (%s, acl = %s, version = %d)&quot;, path, acl, version);</span>
            }

            @Override
            void zkRun() {
<span class="nc" id="L635">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L637">                    ZooKeeperClient.super.setACL(path, acl, version, stCb, worker);</span>
                } else {
<span class="nc" id="L639">                    zkHandle.setACL(path, acl, version, stCb, worker);</span>
                }
<span class="nc" id="L641">            }</span>
        };
        // execute it immediately
<span class="nc" id="L644">        proc.run();</span>
<span class="nc" id="L645">    }</span>

    @Override
    public void sync(final String path, final VoidCallback cb, final Object context) {
<span class="nc" id="L649">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, syncStats) {</span>

<span class="nc" id="L651">            final VoidCallback vCb = new VoidCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx) {
<span class="nc" id="L655">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L657">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L659">                        cb.processResult(rc, path, context);</span>
                    }
<span class="nc" id="L661">                }</span>

            };

            @Override
            public String toString() {
<span class="nc" id="L667">                return String.format(&quot;sync (%s)&quot;, path);</span>
            }

            @Override
            void zkRun() {
<span class="nc" id="L672">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L674">                    ZooKeeperClient.super.sync(path, vCb, worker);</span>
                } else {
<span class="nc" id="L676">                    zkHandle.sync(path, vCb, worker);</span>
                }
<span class="nc" id="L678">            }</span>
        };
        // execute it immediately
<span class="nc" id="L681">        proc.run();</span>
<span class="nc" id="L682">    }</span>

    @Override
    public States getState() {
<span class="nc" id="L686">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L688">            return ZooKeeperClient.super.getState();</span>
        } else {
<span class="nc" id="L690">            return zkHandle.getState();</span>
        }
    }

    @Override
    public String toString() {
<span class="nc" id="L696">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L698">            return ZooKeeperClient.super.toString();</span>
        } else {
<span class="nc" id="L700">            return zkHandle.toString();</span>
        }
    }

    @Override
    public String create(final String path, final byte[] data,
            final List&lt;ACL&gt; acl, final CreateMode createMode)
                    throws KeeperException, InterruptedException {
<span class="nc" id="L708">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;String&gt;() {</span>

            @Override
            public String call() throws KeeperException, InterruptedException {
<span class="nc" id="L712">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L714">                    return ZooKeeperClient.super.create(path, data, acl, createMode);</span>
                }
<span class="nc" id="L716">                return zkHandle.create(path, data, acl, createMode);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L721">                return String.format(&quot;create (%s, acl = %s, mode = %s)&quot;, path, acl, createMode);</span>
            }

        }, operationRetryPolicy, rateLimiter, createStats);
    }

    @Override
    public void create(final String path, final byte[] data, final List&lt;ACL&gt; acl,
            final CreateMode createMode, final StringCallback cb, final Object context) {
<span class="nc" id="L730">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, createStats) {</span>

<span class="nc" id="L732">            final StringCallback createCb = new StringCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, String name) {
<span class="nc" id="L736">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L738">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L740">                        cb.processResult(rc, path, context, name);</span>
                    }
<span class="nc" id="L742">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L748">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L750">                    ZooKeeperClient.super.create(path, data, acl, createMode, createCb, worker);</span>
                } else {
<span class="nc" id="L752">                    zkHandle.create(path, data, acl, createMode, createCb, worker);</span>
                }
<span class="nc" id="L754">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L758">                return String.format(&quot;create (%s, acl = %s, mode = %s)&quot;, path, acl, createMode);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L762">        proc.run();</span>
<span class="nc" id="L763">    }</span>

    @Override
    public void delete(final String path, final int version) throws KeeperException, InterruptedException {
<span class="nc" id="L767">        ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Void&gt;() {</span>

            @Override
            public Void call() throws KeeperException, InterruptedException {
<span class="nc" id="L771">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L773">                    ZooKeeperClient.super.delete(path, version);</span>
                } else {
<span class="nc" id="L775">                    zkHandle.delete(path, version);</span>
                }
<span class="nc" id="L777">                return null;</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L782">                return String.format(&quot;delete (%s, version = %d)&quot;, path, version);</span>
            }

        }, operationRetryPolicy, rateLimiter, deleteStats);
<span class="nc" id="L786">    }</span>

    @Override
    public void delete(final String path, final int version, final VoidCallback cb, final Object context) {
<span class="nc" id="L790">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, deleteStats) {</span>

<span class="nc" id="L792">            final VoidCallback deleteCb = new VoidCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx) {
<span class="nc" id="L796">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L798">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L800">                        cb.processResult(rc, path, context);</span>
                    }
<span class="nc" id="L802">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L808">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L810">                    ZooKeeperClient.super.delete(path, version, deleteCb, worker);</span>
                } else {
<span class="nc" id="L812">                    zkHandle.delete(path, version, deleteCb, worker);</span>
                }
<span class="nc" id="L814">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L818">                return String.format(&quot;delete (%s, version = %d)&quot;, path, version);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L822">        proc.run();</span>
<span class="nc" id="L823">    }</span>

    @Override
    public Stat exists(final String path, final Watcher watcher) throws KeeperException, InterruptedException {
<span class="nc" id="L827">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L831">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L833">                    return ZooKeeperClient.super.exists(path, watcher);</span>
                }
<span class="nc" id="L835">                return zkHandle.exists(path, watcher);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L840">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, existsStats);
    }

    @Override
    public Stat exists(final String path, final boolean watch) throws KeeperException, InterruptedException {
<span class="nc" id="L848">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L852">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L854">                    return ZooKeeperClient.super.exists(path, watch);</span>
                }
<span class="nc" id="L856">                return zkHandle.exists(path, watch);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L861">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, existsStats);
    }

    @Override
    public void exists(final String path, final Watcher watcher, final StatCallback cb, final Object context) {
<span class="nc" id="L869">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, existsStats) {</span>

<span class="nc" id="L871">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L875">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L877">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L879">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L881">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L887">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L889">                    ZooKeeperClient.super.exists(path, watcher, stCb, worker);</span>
                } else {
<span class="nc" id="L891">                    zkHandle.exists(path, watcher, stCb, worker);</span>
                }
<span class="nc" id="L893">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L897">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L901">        proc.run();</span>
<span class="nc" id="L902">    }</span>

    @Override
    public void exists(final String path, final boolean watch, final StatCallback cb, final Object context) {
<span class="nc" id="L906">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, existsStats) {</span>

<span class="nc" id="L908">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L912">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L914">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L916">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L918">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L924">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L926">                    ZooKeeperClient.super.exists(path, watch, stCb, worker);</span>
                } else {
<span class="nc" id="L928">                    zkHandle.exists(path, watch, stCb, worker);</span>
                }
<span class="nc" id="L930">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L934">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L938">        proc.run();</span>
<span class="nc" id="L939">    }</span>

    @Override
    public byte[] getData(final String path, final Watcher watcher, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L944">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;byte[]&gt;() {</span>

            @Override
            public byte[] call() throws KeeperException, InterruptedException {
<span class="nc" id="L948">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L950">                    return ZooKeeperClient.super.getData(path, watcher, stat);</span>
                }
<span class="nc" id="L952">                return zkHandle.getData(path, watcher, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L957">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, getStats);
    }

    @Override
    public byte[] getData(final String path, final boolean watch, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L966">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;byte[]&gt;() {</span>

            @Override
            public byte[] call() throws KeeperException, InterruptedException {
<span class="nc" id="L970">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L972">                    return ZooKeeperClient.super.getData(path, watch, stat);</span>
                }
<span class="nc" id="L974">                return zkHandle.getData(path, watch, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L979">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, getStats);
    }

    @Override
    public void getData(final String path, final Watcher watcher, final DataCallback cb, final Object context) {
<span class="nc" id="L987">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getStats) {</span>

<span class="nc" id="L989">            final DataCallback dataCb = new DataCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {
<span class="nc" id="L993">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L995">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L997">                        cb.processResult(rc, path, context, data, stat);</span>
                    }
<span class="nc" id="L999">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1005">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1007">                    ZooKeeperClient.super.getData(path, watcher, dataCb, worker);</span>
                } else {
<span class="nc" id="L1009">                    zkHandle.getData(path, watcher, dataCb, worker);</span>
                }
<span class="nc" id="L1011">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1015">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1019">        proc.run();</span>
<span class="nc" id="L1020">    }</span>

    @Override
    public void getData(final String path, final boolean watch, final DataCallback cb, final Object context) {
<span class="nc" id="L1024">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getStats) {</span>

<span class="nc" id="L1026">            final DataCallback dataCb = new DataCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {
<span class="nc" id="L1030">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1032">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1034">                        cb.processResult(rc, path, context, data, stat);</span>
                    }
<span class="nc" id="L1036">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1042">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1044">                    ZooKeeperClient.super.getData(path, watch, dataCb, worker);</span>
                } else {
<span class="nc" id="L1046">                    zkHandle.getData(path, watch, dataCb, worker);</span>
                }
<span class="nc" id="L1048">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1052">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1056">        proc.run();</span>
<span class="nc" id="L1057">    }</span>

    @Override
    public Stat setData(final String path, final byte[] data, final int version)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1062">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L1066">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1068">                    return ZooKeeperClient.super.setData(path, data, version);</span>
                }
<span class="nc" id="L1070">                return zkHandle.setData(path, data, version);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1075">                return String.format(&quot;setData (%s, version = %d)&quot;, path, version);</span>
            }

        }, operationRetryPolicy, rateLimiter, setStats);
    }

    @Override
    public void setData(final String path, final byte[] data, final int version,
            final StatCallback cb, final Object context) {
<span class="nc" id="L1084">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, setStats) {</span>

<span class="nc" id="L1086">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L1090">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1092">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1094">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L1096">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1102">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1104">                    ZooKeeperClient.super.setData(path, data, version, stCb, worker);</span>
                } else {
<span class="nc" id="L1106">                    zkHandle.setData(path, data, version, stCb, worker);</span>
                }
<span class="nc" id="L1108">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1112">                return String.format(&quot;setData (%s, version = %d)&quot;, path, version);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1116">        proc.run();</span>
<span class="nc" id="L1117">    }</span>

    @Override
    public List&lt;String&gt; getChildren(final String path, final Watcher watcher, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1122">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1126">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1128">                    return ZooKeeperClient.super.getChildren(path, watcher, stat);</span>
                }
<span class="nc" id="L1130">                return zkHandle.getChildren(path, watcher, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1135">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public List&lt;String&gt; getChildren(final String path, final boolean watch, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1144">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1148">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1150">                    return ZooKeeperClient.super.getChildren(path, watch, stat);</span>
                }
<span class="nc" id="L1152">                return zkHandle.getChildren(path, watch, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1157">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public void getChildren(final String path, final Watcher watcher,
            final Children2Callback cb, final Object context) {
<span class="nc" id="L1166">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="nc" id="L1168">            final Children2Callback childCb = new Children2Callback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children, Stat stat) {
<span class="nc" id="L1173">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1174" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1175">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1177">                        cb.processResult(rc, path, context, children, stat);</span>
                    }
<span class="nc" id="L1179">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1185">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1187">                    ZooKeeperClient.super.getChildren(path, watcher, childCb, worker);</span>
                } else {
<span class="nc" id="L1189">                    zkHandle.getChildren(path, watcher, childCb, worker);</span>
                }
<span class="nc" id="L1191">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1195">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1199">        proc.run();</span>
<span class="nc" id="L1200">    }</span>

    @Override
    public void getChildren(final String path, final boolean watch, final Children2Callback cb,
            final Object context) {
<span class="nc" id="L1205">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="nc" id="L1207">            final Children2Callback childCb = new Children2Callback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children, Stat stat) {
<span class="nc" id="L1212">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1214">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1216">                        cb.processResult(rc, path, context, children, stat);</span>
                    }
<span class="nc" id="L1218">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1224">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1225" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1226">                    ZooKeeperClient.super.getChildren(path, watch, childCb, worker);</span>
                } else {
<span class="nc" id="L1228">                    zkHandle.getChildren(path, watch, childCb, worker);</span>
                }
<span class="nc" id="L1230">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1234">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1238">        proc.run();</span>
<span class="nc" id="L1239">    }</span>


    @Override
    public List&lt;String&gt; getChildren(final String path, final Watcher watcher)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1245">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1249">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1251">                    return ZooKeeperClient.super.getChildren(path, watcher);</span>
                }
<span class="nc" id="L1253">                return zkHandle.getChildren(path, watcher);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1258">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public List&lt;String&gt; getChildren(final String path, final boolean watch)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1267">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1271">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1273">                    return ZooKeeperClient.super.getChildren(path, watch);</span>
                }
<span class="nc" id="L1275">                return zkHandle.getChildren(path, watch);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1280">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public void getChildren(final String path, final Watcher watcher,
            final ChildrenCallback cb, final Object context) {
<span class="nc" id="L1289">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="nc" id="L1291">            final ChildrenCallback childCb = new ChildrenCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children) {
<span class="nc" id="L1296">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1298">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1300">                        cb.processResult(rc, path, context, children);</span>
                    }
<span class="nc" id="L1302">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1308">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1310">                    ZooKeeperClient.super.getChildren(path, watcher, childCb, worker);</span>
                } else {
<span class="nc" id="L1312">                    zkHandle.getChildren(path, watcher, childCb, worker);</span>
                }
<span class="nc" id="L1314">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1318">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1322">        proc.run();</span>
<span class="nc" id="L1323">    }</span>

    @Override
    public void getChildren(final String path, final boolean watch,
            final ChildrenCallback cb, final Object context) {
<span class="nc" id="L1328">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="nc" id="L1330">            final ChildrenCallback childCb = new ChildrenCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children) {
<span class="nc" id="L1335">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1336" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1337">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1339">                        cb.processResult(rc, path, context, children);</span>
                    }
<span class="nc" id="L1341">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1347">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1349">                    ZooKeeperClient.super.getChildren(path, watch, childCb, worker);</span>
                } else {
<span class="nc" id="L1351">                    zkHandle.getChildren(path, watch, childCb, worker);</span>
                }
<span class="nc" id="L1353">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1357">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1361">        proc.run();</span>
<span class="nc" id="L1362">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>